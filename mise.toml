[tools]
node = "22"
pnpm = "latest"
python = "3.12"
uv = "latest"

[env]
VIRTUAL_ENV = "{{config_root}}/backend/.venv"
_.file = ["frontend/.env", "backend/.env"]

# =============================================================================
# Install
# =============================================================================
[tasks.install]
description = "Install all dependencies"
depends = ["install:backend", "install:frontend"]

[tasks."install:backend"]
description = "Install backend dependencies"
dir = "backend"
run = "uv sync"

[tasks."install:frontend"]
description = "Install frontend dependencies"
dir = "frontend"
run = "pnpm install"

# =============================================================================
# Development
# =============================================================================
[tasks.dev]
description = "Start all services (Docker)"
run = "docker compose up"

[tasks."dev:backend"]
description = "Start backend dev server"
dir = "backend"
run = "uv run uvicorn src.main:app --reload"

[tasks."dev:frontend"]
description = "Start frontend dev server"
dir = "frontend"
run = "pnpm dev"

# =============================================================================
# Build
# =============================================================================
[tasks.build]
description = "Build all Docker images"
depends = ["build:backend", "build:frontend"]

[tasks."build:backend"]
description = "Build backend Docker image"
run = "docker compose build backend"

[tasks."build:frontend"]
description = "Build frontend Docker image"
run = "docker compose build frontend"

[tasks."build:frontend:local"]
description = "Build frontend locally"
dir = "frontend"
run = "pnpm build"

# =============================================================================
# Lint
# =============================================================================
[tasks.lint]
description = "Lint all code"
depends = ["lint:backend", "lint:frontend"]

[tasks."lint:backend"]
description = "Lint backend"
dir = "backend"
run = "uv run ruff check ."

[tasks."lint:backend:fix"]
description = "Lint and fix backend"
dir = "backend"
run = "uv run ruff check --fix ."

[tasks."lint:frontend"]
description = "Lint frontend"
dir = "frontend"
run = "pnpm lint"

[tasks."lint:frontend:fix"]
description = "Lint and fix frontend"
dir = "frontend"
run = "pnpm lint:fix"

# =============================================================================
# Format
# =============================================================================
[tasks.format]
description = "Format all code"
depends = ["format:backend", "format:frontend"]

[tasks."format:backend"]
dir = "backend"
run = "uv run ruff format ."

[tasks."format:frontend"]
dir = "frontend"
run = "pnpm format"

[tasks."format:check"]
description = "Check formatting (CI)"
depends = ["format:check:backend", "format:check:frontend"]

[tasks."format:check:backend"]
dir = "backend"
run = "uv run ruff format --check ."

[tasks."format:check:frontend"]
dir = "frontend"
run = "pnpm format:check"

# =============================================================================
# Test
# =============================================================================
[tasks.test]
description = "Run all tests"
depends = ["test:backend", "test:frontend"]

[tasks."test:backend"]
description = "Run backend tests"
dir = "backend"
run = "uv run pytest"

[tasks."test:backend:unit"]
description = "Backend unit tests only"
dir = "backend"
run = "uv run pytest --ignore=tests/integration"

[tasks."test:integration"]
description = "Backend integration tests"
dir = "backend"
run = "uv run pytest tests/integration -v"

[tasks."test:frontend"]
description = "Run frontend unit tests"
dir = "frontend"
run = "pnpm test"

[tasks."test:frontend:watch"]
description = "Frontend tests (watch mode)"
dir = "frontend"
run = "pnpm test:watch"

[tasks."test:e2e"]
description = "Run e2e tests"
dir = "frontend"
run = "pnpm test:e2e"

[tasks."test:e2e:ui"]
description = "E2e tests with Playwright UI"
dir = "frontend"
run = "pnpm test:e2e:ui"

[tasks."test:e2e:headed"]
description = "E2e tests in headed mode"
dir = "frontend"
run = "pnpm test:e2e:headed"

[tasks."test:e2e:debug"]
description = "E2e tests in debug mode"
dir = "frontend"
run = "pnpm test:e2e:debug"

# =============================================================================
# Database
# =============================================================================
[tasks."db:migrate"]
description = "Run migrations"
dir = "backend"
run = "uv run alembic upgrade head"

[tasks."db:migration"]
description = "Create a new migration"
dir = "backend"
run = "uv run alembic revision --autogenerate -m"

[tasks."db:reset"]
description = "Reset database"
run = [
  "docker compose exec db psql -U homerp -d homerp -c 'DROP SCHEMA public CASCADE; CREATE SCHEMA public;'",
  "mise run db:migrate",
]

# =============================================================================
# API & Utilities
# =============================================================================
[tasks."api:generate"]
description = "Generate API client from OpenAPI"
dir = "frontend"
run = "pnpm generate-api"

[tasks.clean]
description = "Clean build artifacts"
run = "rm -rf backend/.venv frontend/node_modules frontend/.next"

# =============================================================================
# CI Checks
# =============================================================================
[tasks.check]
description = "Run all CI checks"
depends = ["lint", "format:check", "test:backend", "test:frontend", "build:frontend:local"]

[tasks."check:backend"]
description = "Run backend CI checks"
depends = ["lint:backend", "format:check:backend", "test:backend"]

[tasks."check:frontend"]
description = "Run frontend CI checks"
depends = ["lint:frontend", "format:check:frontend", "test:frontend", "build:frontend:local"]
