[tools]
node = "20"
pnpm = "latest"
python = "3.12"
uv = "latest"

[env]
VIRTUAL_ENV = "{{config_root}}/backend/.venv"

[tasks.install]
description = "Install all dependencies"
run = ["mise run install:backend", "mise run install:frontend"]

[tasks."install:backend"]
description = "Install backend dependencies"
dir = "backend"
run = "uv sync"

[tasks."install:frontend"]
description = "Install frontend dependencies"
dir = "frontend"
run = "pnpm install"

[tasks.dev]
description = "Start all services for development"
run = "docker compose up"

[tasks."dev:backend"]
description = "Start backend dev server (without Docker)"
dir = "backend"
run = "uv run uvicorn src.main:app --reload"

[tasks."dev:frontend"]
description = "Start frontend dev server (without Docker)"
dir = "frontend"
run = "pnpm dev"

[tasks.build]
description = "Build all services"
run = ["mise run build:backend", "mise run build:frontend"]

[tasks."build:backend"]
description = "Build backend Docker image"
run = "docker compose build backend"

[tasks."build:frontend"]
description = "Build frontend Docker image"
run = "docker compose build frontend"

[tasks.lint]
description = "Lint all code"
run = ["mise run lint:backend", "mise run lint:frontend"]

[tasks."lint:backend"]
description = "Lint backend code"
dir = "backend"
run = "uv run ruff check ."

[tasks."lint:frontend"]
description = "Lint frontend code"
dir = "frontend"
run = "pnpm lint"

[tasks.format]
description = "Format all code"
run = ["mise run format:backend", "mise run format:frontend"]

[tasks."format:backend"]
description = "Format backend code"
dir = "backend"
run = "uv run ruff format ."

[tasks."format:frontend"]
description = "Format frontend code"
dir = "frontend"
run = "pnpm prettier --write src/"

[tasks.test]
description = "Run all tests"
run = ["mise run test:backend"]

[tasks."test:backend"]
description = "Run backend tests"
dir = "backend"
run = "uv run pytest"

[tasks."db:migrate"]
description = "Run database migrations"
dir = "backend"
run = "uv run alembic upgrade head"

[tasks."db:reset"]
description = "Reset database (drop all tables and re-run migrations)"
run = [
  "docker compose exec db psql -U homerp -d homerp -c 'DROP SCHEMA public CASCADE; CREATE SCHEMA public;'",
  "mise run db:migrate",
]

[tasks."db:migration"]
description = "Create a new migration"
dir = "backend"
run = "uv run alembic revision --autogenerate -m"

[tasks."api:generate"]
description = "Generate frontend API client from OpenAPI spec"
dir = "frontend"
run = "pnpm generate-api"

[tasks.clean]
description = "Clean build artifacts"
run = [
  "rm -rf backend/.venv",
  "rm -rf frontend/node_modules",
  "rm -rf frontend/.next",
]
