[tools]
node = "22"
pnpm = "latest"
python = "3.12"
uv = "latest"

[env]
VIRTUAL_ENV = "{{config_root}}/backend/.venv"
_.file = ["frontend/.env", "backend/.env"]

[tasks.install]
description = "Install all dependencies"
run = ["mise run install:backend", "mise run install:frontend"]

[tasks."install:backend"]
description = "Install backend dependencies"
dir = "backend"
run = "uv sync"

[tasks."install:frontend"]
description = "Install frontend dependencies"
dir = "frontend"
run = "pnpm install"

[tasks.dev]
description = "Start all services for development"
run = "docker compose up"

[tasks."dev:backend"]
description = "Start backend dev server (without Docker)"
dir = "backend"
run = "uv run uvicorn src.main:app --reload"

[tasks."dev:frontend"]
description = "Start frontend dev server (without Docker)"
dir = "frontend"
run = "pnpm dev"

[tasks.build]
description = "Build all Docker images"
run = ["mise run build:backend", "mise run build:frontend"]

[tasks."build:backend"]
description = "Build backend Docker image"
run = "docker compose build backend"

[tasks."build:frontend"]
description = "Build frontend Docker image"
run = "docker compose build frontend"

[tasks."build:frontend:local"]
description = "Build frontend locally (Next.js production build)"
dir = "frontend"
run = "pnpm build"

[tasks.lint]
description = "Lint all code"
run = ["mise run lint:backend", "mise run lint:frontend"]

[tasks."lint:backend"]
description = "Lint backend code"
dir = "backend"
run = "uv run ruff check ."

[tasks."lint:backend:fix"]
description = "Lint and fix backend code"
dir = "backend"
run = "uv run ruff check --fix ."

[tasks."lint:frontend"]
description = "Lint frontend code"
dir = "frontend"
run = "pnpm lint"

[tasks."lint:frontend:fix"]
description = "Lint and fix frontend code"
dir = "frontend"
run = "pnpm lint:fix"

[tasks.format]
description = "Format all code"
run = ["mise run format:backend", "mise run format:frontend"]

[tasks."format:backend"]
description = "Format backend code"
dir = "backend"
run = "uv run ruff format ."

[tasks."format:frontend"]
description = "Format frontend code"
dir = "frontend"
run = "pnpm format"

[tasks."format:check"]
description = "Check formatting for all code (CI)"
run = ["mise run format:check:backend", "mise run format:check:frontend"]

[tasks."format:check:backend"]
description = "Check backend code formatting (CI)"
dir = "backend"
run = "uv run ruff format --check ."

[tasks."format:check:frontend"]
description = "Check frontend code formatting (CI)"
dir = "frontend"
run = "pnpm format:check"

[tasks.test]
description = "Run all tests"
run = ["mise run test:backend", "mise run test:frontend"]

[tasks."test:backend"]
description = "Run backend tests"
dir = "backend"
run = "uv run pytest"

[tasks."test:backend:unit"]
description = "Run backend unit tests only (excludes integration)"
dir = "backend"
run = "uv run pytest --ignore=tests/integration"

[tasks."test:integration"]
description = "Run backend integration tests (security-critical tests)"
dir = "backend"
run = "uv run pytest tests/integration -v"

[tasks."test:frontend"]
description = "Run frontend unit tests (vitest)"
dir = "frontend"
run = "pnpm test"

[tasks."test:frontend:watch"]
description = "Run frontend unit tests in watch mode"
dir = "frontend"
run = "pnpm test:watch"

[tasks."test:e2e"]
description = "Run frontend e2e tests (playwright)"
dir = "frontend"
run = "pnpm test:e2e"

[tasks."test:e2e:ui"]
description = "Run frontend e2e tests with Playwright UI"
dir = "frontend"
run = "pnpm test:e2e:ui"

[tasks."test:e2e:headed"]
description = "Run frontend e2e tests in headed browser mode"
dir = "frontend"
run = "pnpm test:e2e:headed"

[tasks."test:e2e:debug"]
description = "Run frontend e2e tests in debug mode"
dir = "frontend"
run = "pnpm test:e2e:debug"

[tasks."db:migrate"]
description = "Run database migrations"
dir = "backend"
run = "uv run alembic upgrade head"

[tasks."db:reset"]
description = "Reset database (drop all tables and re-run migrations)"
run = [
  "docker compose exec db psql -U homerp -d homerp -c 'DROP SCHEMA public CASCADE; CREATE SCHEMA public;'",
  "mise run db:migrate",
]

[tasks."db:migration"]
description = "Create a new migration"
dir = "backend"
run = "uv run alembic revision --autogenerate -m"

[tasks."api:generate"]
description = "Generate frontend API client from OpenAPI spec"
dir = "frontend"
run = "pnpm generate-api"

[tasks.clean]
description = "Clean build artifacts"
run = [
  "rm -rf backend/.venv",
  "rm -rf frontend/node_modules",
  "rm -rf frontend/.next",
]

[tasks.check]
description = "Run all CI checks (lint, format, tests, build)"
run = [
  "mise run lint",
  "mise run format:check",
  "mise run test:backend",
  "mise run test:frontend",
  "mise run build:frontend:local",
]

[tasks."check:backend"]
description = "Run backend CI checks (lint, format, tests)"
run = [
  "mise run lint:backend",
  "mise run format:check:backend",
  "mise run test:backend",
]

[tasks."check:frontend"]
description = "Run frontend CI checks (lint, format, tests, build)"
run = [
  "mise run lint:frontend",
  "mise run format:check:frontend",
  "mise run test:frontend",
  "mise run build:frontend:local",
]
