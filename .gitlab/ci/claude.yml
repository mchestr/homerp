# Claude Code AI assistant job

.claude_base:
  stage: ai
  image: node:24-alpine3.21
  variables:
    GIT_STRATEGY: fetch
    CLAUDE_CODE_OAUTH_TOKEN: $CLAUDE_CODE_OAUTH_TOKEN
  before_script:
    - apk update
    - apk add --no-cache git curl bash jq
    - npm install -g @anthropic-ai/claude-code

claude:
  extends: .claude_base
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  script:
    - /bin/gitlab-mcp-server || true
    - |
      claude \
        -p "${AI_FLOW_INPUT:-'Review this merge request. Check for: 1) Bugs or logic errors, 2) Security issues (injection, auth, data exposure), 3) Performance problems, 4) Code style and best practices per CLAUDE.md. Be concise and actionable. Only comment on significant issues.'}" \
        --permission-mode acceptEdits \
        --allowedTools "Bash(*) Read(*) Edit(*) Write(*) mcp__gitlab" \
        --debug

# Triggered by webhook on issue creation
# Setup:
#   1. Create a pipeline trigger token: Settings > CI/CD > Pipeline triggers
#   2. Create a webhook: Settings > Webhooks
#      - URL: https://gitlab.com/api/v4/projects/<PROJECT_ID>/trigger/pipeline
#      - Secret token: <your-trigger-token>
#      - Trigger: Issues events
#      - Add custom header or use a webhook relay that passes ISSUE_IID
#   3. Alternative: Use GitLab's native webhook to trigger pipeline via API
claude:label-issue:
  extends: .claude_base
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger" && $ISSUE_IID
  script:
    - |
      claude \
        -p "You are an issue labeling assistant for a GitLab project.

      Project: $CI_PROJECT_PATH (ID: $CI_PROJECT_ID)
      Issue IID: $ISSUE_IID

      Your task:
      1. First, fetch the issue details:
         glab api projects/$CI_PROJECT_ID/issues/$ISSUE_IID

      2. Analyze the issue title and description to determine appropriate labels

      3. Check existing labels in the project:
         glab api projects/$CI_PROJECT_ID/labels | jq -r '.[].name'

      4. If a label you want to apply does not exist, create it with an appropriate color:
         glab api projects/$CI_PROJECT_ID/labels --method POST -f name=<label> -f color=<hex_color>

      5. Apply labels to the issue:
         glab api projects/$CI_PROJECT_ID/issues/$ISSUE_IID --method PUT -f 'labels=<comma-separated-labels>'

      Label categories to consider:
      - Type: bug, feature, enhancement, documentation, refactor, test, chore
      - Priority: priority::low, priority::medium, priority::high, priority::critical
      - Component: frontend, backend, database, ai, billing, auth, infrastructure
      - Status: needs-triage, needs-info, good-first-issue

      Color suggestions:
      - bug: #FF0000 (red)
      - feature: #428BCA (blue)
      - enhancement: #5CB85C (green)
      - documentation: #F0AD4E (orange)
      - frontend: #61DAFB (cyan)
      - backend: #3572A5 (python blue)
      - priority::critical: #DC3545 (dark red)
      - priority::high: #FD7E14 (orange)
      - priority::medium: #FFC107 (yellow)
      - priority::low: #6C757D (gray)

      Be conservative with labels - only apply labels that clearly match the issue content.
      Always include at least one type label and one component label if determinable." \
        --permission-mode acceptEdits \
        --allowedTools "Bash(glab:*) Bash(jq:*)" \
        --debug
