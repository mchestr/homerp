# Claude Code AI assistant job

claude:
  stage: ai
  image: node:24-alpine3.21
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  variables:
    GIT_STRATEGY: fetch
    ANTHROPIC_API_KEY: $ANTHROPIC_API_KEY
  before_script:
    - apk update
    - apk add --no-cache git curl bash
    - npm install -g @anthropic-ai/claude-code
  script:
    - /bin/gitlab-mcp-server || true
    - |
      claude \
        -p "${AI_FLOW_INPUT:-'Review this merge request. Check for: 1) Bugs or logic errors, 2) Security issues (injection, auth, data exposure), 3) Performance problems, 4) Code style and best practices per CLAUDE.md. Be concise and actionable. Only comment on significant issues.'}" \
        --permission-mode acceptEdits \
        --allowedTools "Bash(*) Read(*) Edit(*) Write(*) mcp__gitlab" \
        --debug
